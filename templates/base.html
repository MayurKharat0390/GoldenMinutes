{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="description" content="Golden Minutes - Decentralized Response Network">

    <!-- PWA Settings -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="{% static 'images/icon-192.png' %}">

    <title>{% block title %}Golden Minutes{% endblock %}</title>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{% static 'sw.js' %}")
                    .then(reg => console.log('SW registered!', reg))
                    .catch(err => console.log('SW failed!', err));
            });
        }
    </script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Custom CSS (Version 23 - Premium Features) -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}?v=23">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/images/icon-192.png">

    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Navigation (Image Match: Minimalist) -->
    <nav class="navbar navbar-expand-lg navbar-minimal sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="/">
                <i class="bi bi-shield-check text-danger" style="font-size: 1.2rem;"></i>
                <span class="fw-bold"
                    style="font-family: 'Plus Jakarta Sans'; font-size: 1.1rem; color: #0B0F19;">Golden Minutes</span>
            </a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center gap-4">
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link text-dark fw-medium" href="{% url 'emergencies:emergency_map' %}"
                            style="font-size: 0.9rem;">Live Map</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark fw-medium" href="{% url 'responders:volunteer_dashboard' %}"
                            style="font-size: 0.9rem;">Dashboard</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle fw-bold text-dark" href="#" data-bs-toggle="dropdown"
                            style="font-size: 0.9rem;">
                            {{ user.username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow-lg mt-2 rounded-3 p-2">
                            {% if user.is_staff %}
                            <li>
                                <a class="dropdown-item rounded-2 text-primary"
                                    href="{% url 'responders:admin_analytics' %}">
                                    <i class="bi bi-graph-up me-2"></i>Analytics
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item rounded-2 text-primary"
                                    href="{% url 'responders:admin_approvals' %}">
                                    <i class="bi bi-shield-check me-2"></i>Verification Hub
                                </a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            {% endif %}
                            <li><a class="dropdown-item rounded-2" href="{% url 'accounts:profile' %}">Profile</a></li>
                            <li><a class="dropdown-item rounded-2 text-danger" href="{% url 'accounts:logout' %}">Log
                                    Out</a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link text-dark fw-medium" href="{% url 'accounts:login' %}"
                            style="font-size: 0.9rem;">Login</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark fw-medium" href="{% url 'accounts:register' %}"
                            style="font-size: 0.9rem;">Register</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-nav-outline" href="{% url 'accounts:register' %}">
                            Join Force
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
    <div class="container mt-4 position-absolute start-50 translate-middle-x" style="z-index: 1100; max-width: 600px;">
        {% for message in messages %}
        <div class="alert alert-light shadow-sm border-0 d-flex align-items-center" role="alert"
            style="border-left: 4px solid var(--brand-red) !important;">
            <div class="fw-medium text-dark">{{ message }}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main Content -->
    <main class="flex-grow-1">
        {% block content %}{% endblock %}
    </main>

    <!-- Floating SOS (Image Match) -->
    {% if user.is_authenticated and user.role != 'admin' %}
    <a href="{% url 'emergencies:trigger_sos' %}" class="sos-float-btn" id="sosButton">
        SOS
    </a>
    {% endif %}

    <!-- Footer (Image Match) -->
    <footer class="footer-minimal bg-white border-top border-light">
        <div class="container">
            <div class="row g-5">
                <div class="col-lg-4">
                    <div class="d-flex align-items-center gap-2 mb-4">
                        <i class="bi bi-shield-check text-danger"></i>
                        <span class="fw-bold text-dark">Golden Minutes</span>
                    </div>
                    <p class="text-secondary small mb-4" style="max-width: 300px; line-height: 1.6;">
                        Bridging the gap between emergency and response using verified hyper-local volunteers.
                    </p>
                    <div class="d-flex gap-3 text-secondary h5">
                        <i class="bi bi-globe"></i>
                        <i class="bi bi-twitter-x"></i>
                    </div>
                </div>

                <div class="col-lg-2 col-6">
                    <h6 class="footer-heading">Platform</h6>
                    <a href="#" class="footer-link">Live Grid</a>
                    <a href="#" class="footer-link">Volunteer Dashboard</a>
                    <a href="#" class="footer-link">Training Center</a>
                    <a href="#" class="footer-link">API Access</a>
                </div>

                <div class="col-lg-2 col-6">
                    <h6 class="footer-heading">Legal</h6>
                    <a href="#" class="footer-link">Privacy Policy</a>
                    <a href="#" class="footer-link">Terms of Service</a>
                    <a href="#" class="footer-link">Liability Waiver</a>
                    <a href="#" class="footer-link">Cookie Policy</a>
                </div>

                <div class="col-lg-4">
                    <h6 class="footer-heading">24/7 Support</h6>
                    <div class="support-box">
                        <small class="d-block text-secondary mb-1 fw-bold" style="font-size: 0.7rem;">Critical
                            Line</small>
                        <div class="fw-bold text-dark fs-5 mb-2">1-800-GOLD-MIN</div>
                        <a href="#" class="text-danger fw-bold text-decoration-none" style="font-size: 0.8rem;">Start
                            Live Chat</a>
                    </div>
                </div>
            </div>

            <div class="row mt-5 pt-4 border-top border-light align-items-center">
                <div class="col-md-6 text-center text-md-start">
                    <small class="text-secondary">&copy; 2024 Golden Minutes Response Network. All rights
                        reserved.</small>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <small
                        class="text-success fw-bold d-flex align-items-center justify-content-center justify-content-md-end gap-1">
                        <div class="rounded-circle bg-success" style="width: 8px; height: 8px;"></div> All Systems
                        Operational
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- Emergency Alert Modal -->
    <div class="modal fade" id="emergencyAlertModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-left: 10px solid #dc3545;">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-exclamation-triangle-fill me-2 pulse-animation"></i>EMERGENCY ALERT
                    </h5>
                    <!-- Remove close button to force action -->
                </div>
                <div class="modal-body p-4 text-center">
                    <div class="display-1 text-danger mb-3 animate-bell">
                        <i class="bi bi-bell-fill"></i>
                    </div>
                    <h4 class="fw-bold mb-2">New Emergency Reported!</h4>
                    <p class="lead" id="alert-type">Cardiac Arrest</p>
                    <div class="alert alert-secondary d-inline-block px-4 py-2 rounded-pill">
                        <i class="bi bi-geo-alt-fill me-1"></i> <span id="alert-location">Location...</span>
                    </div>
                </div>
                <div class="modal-footer border-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4"
                        onclick="dismissAlert()">Dismiss</button>
                    <a href="#" id="alert-view-btn" class="btn btn-danger btn-lg rounded-pill px-5 fw-bold shadow">
                        RESPOND NOW
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio for Alert -->
    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"
        preload="auto"></audio>

    <style>
        @keyframes pulse-red {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-bell {
            animation: pulse-red 1s infinite;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    {% if user.is_authenticated and user.role != 'admin' %}
    <script>
        // Request Notification Permission on Load
        document.addEventListener('DOMContentLoaded', () => {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        });

        // Polling for Alerts
        setInterval(checkAlerts, 5000); // Check every 5 seconds

        let currentAlertId = null;

        function checkAlerts() {
            fetch("{% url 'responders:check_new_emergencies' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.has_new && data.id !== currentAlertId) {
                        showAlert(data);
                    }
                })
                .catch(err => console.error("Polling error:", err));
        }

        function showAlert(data) {
            currentAlertId = data.id;

            // 1. Show In-App Modal
            document.getElementById('alert-type').textContent = data.type;
            document.getElementById('alert-location').textContent = data.location;

            const viewBtn = document.getElementById('alert-view-btn');
            viewBtn.href = `/responders/emergency/${data.id}/detail/`;

            const modal = new bootstrap.Modal(document.getElementById('emergencyAlertModal'));
            modal.show();

            // 2. Play Sound
            const audio = document.getElementById('alertSound');
            audio.play().catch(e => console.log("Audio play failed (user interaction needed first):", e));

            // 3. Trigger Native System Notification (Works in Background)
            if (Notification.permission === "granted") {
                const notif = new Notification("ðŸš¨ EMERGENCY ALERT: " + data.type, {
                    body: `Location: ${data.location}\nClick to Respond!`,
                    icon: "https://cdn-icons-png.flaticon.com/512/564/564619.png", // Red siren icon
                    requireInteraction: true
                });

                notif.onclick = function () {
                    window.focus();
                    window.location.href = viewBtn.href;
                };
            }
        }

        function dismissAlert() {
            // Tell server we saw it
            const formData = new FormData();
            formData.append('emergency_id', currentAlertId);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            fetch("{% url 'responders:ack_alert' %}", {
                method: 'POST',
                body: formData
            }).then(() => {
                const modalEl = document.getElementById('emergencyAlertModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
            });
        }
    </script>
    {% endif %}

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Custom JS -->
    <script src="/static/js/main.js"></script>

    <!-- Push Notifications -->
    <script src="/static/js/notifications.js"></script>

    {% block extra_js %}{% endblock %}

    <!-- PWA Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
    </script>
</body>

</html>